image: registry.stuhome.com/devops/dockerepo/docker:1.0.1

stages:
    - build
    - deploy

build-staging-image:
    stage: build
    services:
        - docker:dind

    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2

    script:
    - star_ci_build staging wing

    only:
    - staging

    allow_failure: false
    when: manual

build-production-image:
    stage: build
    services:
        - docker:dind

    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2

    script:
    - star_ci_build production wing 

    allow_failure: false
    only:
    - master

deploy-staging:
    stage: deploy
    image: registry.stuhome.com/devops/dockerepo/kubectl:1.0.1
    variables:
      env: production
    script:
    - bash ./deploy.sh

    only:
    - staging
    tags:
    - k8s_deploy